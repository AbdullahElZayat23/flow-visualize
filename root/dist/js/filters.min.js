let popup=document.getElementById("popup");function showPopup(){popup.classList.add("active"),toggleButtons()}function closePopup(){popup.classList.remove("active")}function optionSelected(e){if(globalThis.selectedFlow?.name&&globalThis.selectedFlow?.steps?.length)switch(e){case"1":showReport(globalThis.stepsWithErrors.map(e=>({Name:e.text.name.replace("name => ",""),Errors:e.text.errors.replace("Errors => ",""),index:e.index})),["Name","Errors","Index"],globalThis.selectedFlow.name,"steps-with-erros");break;case"2":showReport(globalThis.stepsWithoutCaller.map(e=>({Name:e.name,Template:e.template,index:e.index})),["Name","Is template","Index"],globalThis.selectedFlow.name,"steps-without-caller");break;case"3":showReport(globalThis.duplicatedSteps.map(e=>({Name:e.name})),["Name"],globalThis.selectedFlow.name,"duplicated-steps");break;case"4":showReport(globalThis.allStepsWithErrors.map(t=>({Name:t.text.name.replace("name => ",""),Errors:t.text.errors.replace("Errors => ",""),index:t.index,hasCaller:!globalThis.stepsWithoutCaller.find(e=>e.name==t.text.name.replace("name => ",""))})),["Name","Errors","Index","Has caller"],globalThis.selectedFlow.name,"all-steps-with-errors");break;case"5":showModal(),removeOptions(),addOptions(globalThis.uniqueSteps)}else swal({title:"No Steps To Filter",text:"There are no steps to filter at the moment. Please redner a flow first",icon:"info"});closePopup()}function extractSteps(){let e=[],t=document.getElementById("steps_type").value;if(t){switch(t){case"template":e=globalThis.selectedFlow.steps.filter(e=>e.template);break;case"none":e=globalThis.selectedFlow.steps.filter(e=>!e.type);break;default:e=globalThis.selectedFlow.steps.filter(e=>e.type==t)}closeModal(),e.length?exportFlow({steps:e,name:globalThis.selectedFlow.name}):swal({title:"No Steps Found With The Choosen Criteria",text:"There are no steps With The Choosen Criteria",icon:"info"})}}function showModal(){document.getElementById("moreModal").classList.add("active")}function closeModal(){document.getElementById("moreModal").classList.remove("active")}function showReport(e,t,s,a){e?.length&&createTable(e,t,s,a)}function createTable(e,t,s,a){var o=XLSX.utils.book_new(),e=XLSX.utils.json_to_sheet(e);XLSX.utils.sheet_add_aoa(e,[t],{origin:"A1"}),XLSX.utils.book_append_sheet(o,e,"Steps With Errors"),XLSX.writeFile(o,`${s}-${a}-${(new Date).toISOString()}.xlsx`)}function searchStep(){closeModal();var e=parseInt(document.getElementById("step-number").value);let t;try{if(!(t=globalThis.selectedFlow?.steps[e]))return void swal({title:"Step not Found",text:"There is no step in the tree with the index you entered, or the step has no name. Please check your inputs.",icon:"info"})}catch(e){return void swal({title:"Step not Found",text:"There is no step in the tree with the index you entered, or the step has no name. Please check your inputs.",icon:"info"})}let s=null;var a=document.querySelectorAll(".nodeExample1 p.node-name");for(let e=0;e<a.length;e++)if(a[e].textContent.trim()==="name => "+t?.name&&![...a[e].parentNode.classList].includes("circular_refrence")){s=a[e].parentNode;break}s?(s.scrollIntoView({behavior:"smooth",block:"center"}),s.style.backgroundColor="#ffffcc",setTimeout(function(){s.style.backgroundColor=""},4e3)):swal({title:"Step not Found",text:"There is no step in the tree with the index you entered, or the step has no name. Please check your inputs.",icon:"info"})}function addOptions(e){var t=document.getElementById("steps_dropdown"),e=e?.map(e=>{var t=document.createElement("option");return t.text=e.name,t.value=e.name,t});e?.length&&(t.append(...e),updateDropdown())}function removeOptions(){document.getElementById("steps_dropdown").innerHTML="",updateDropdown()}function updateDropdown(){var e=document.getElementById("steps_dropdown");e.fstdropdown&&e.fstdropdown.rebind()}function extractFlow(){const t=document.getElementById("steps_dropdown")?.value;var e,s=globalThis.selectedFlow?.steps.find(e=>e.name==t);closeModal(),s?(loader.style.display="block",globalThis.flowToExtractVisitedSteps=new Set,(e=kixGlmphvirJsvIbxvegxmsr(s,globalThis.selectedFlow.steps)).unshift(s),s={...globalThis.selectedFlow,steps:e},exportFlow(s)):swal({title:"No Step Found With The Entered Name",text:"Make Sure Step Name Is Correct.",icon:"info"})}function mergeSteps(){if(closeModal(),globalThis.uploadedFileJSOnsData?.steps?.length){var e=globalThis.selectedFlow.steps,t=globalThis.uploadedFileJSOnsData.steps;const s=new Map;e.forEach(e=>{s.set(e.name,e)}),t.forEach(e=>{s.set(e.name,e)}),exportFlow({...globalThis.selectedFlow,steps:Array.from(s.values())},{name:globalThis.selectedFlow.name+"-merged"})}else swal({title:"Select Data Source",text:"Select Data Source To Merge From",icon:"info"})}function addStep(){closeModal();var e=document.getElementById("step-text-area").value;let t,a=[],s=[];try{t=JSON.parse(e)}catch(e){return void swal("Error","Failed to parse JSON data. Please make sure the inserted step/s contains valid / pure JSON data.","error")}(t=Array.isArray(t)?t:[t]).forEach((e,t)=>{var s=jmrhIvvsvw(e);s.length&&a.push({name:e.name,errors:s})}),t.forEach(t=>{globalThis.selectedFlow.steps.find(e=>e.name==t.name)&&s.push(t)}),s.length?(showReport(s.map(e=>({Name:e.name})),["Name"],"new steps","inserted-steps-with-duplication"),swal("Error","Inserted Steps Contains Duplication, See The Exported Sheet For The Details.","error")):a.length?(showReport(a.map(e=>({Name:e.name,Errors:e.errors.join(", ")})),["Name","Errors"],"new steps","inserted-steps-with-errors"),swal("Error","Inserted Steps Contains Errors, See The Exported Sheet For The Details.","error")):(e=globalThis.selectedFlow.steps.concat(t),e={...globalThis.selectedFlow,steps:e},updateFlowVisualization(e))}function traceChildrenPaths(){closeModal(),exportFlow({paths:globalThis.paths},{name:globalThis.selectedFlow.name+"-paths"}),showReport(Object.keys(globalThis.paths).map(e=>({key:e,value:globalThis.paths[e]})).map(e=>({Name:e.key,Paths:e.value?.paths?.join(" , ")})),["Name","Paths"],globalThis.selectedFlow.name,"childrens-trace")}function debounce(s,a){let o;return function(){const e=this,t=arguments;clearTimeout(o),o=setTimeout(function(){s.apply(e,t)},a)}}function handleInputChangeInTextSearch(){let t=document.getElementById("textSearchInput").value,s=[],e=[];var a;t.trim()?.length&&globalThis.selectedFlow?.steps?.length&&(advancedsearch.checked?displayDeepSearchResults(e=deepSearch(t.toLowerCase())):(globalThis.selectedFlow?.steps?.forEach(e=>{e=serachForTextInsideStep(t.toLowerCase(),e);e&&s.push(e)}),displaySearchResults(s)),e.length||s.length)&&((a=document.createElement("i")).className="fa-sharp fa-solid fa-circle-xmark",a.style.cursor="pointer",a.style.float="right",a.style.margin="3px",searchResults.insertBefore(a,searchResults.firstChild),a.addEventListener("click",function(){searchResults.style.display="none"}))}function serachForTextInsideStep(e,t){var s=[],a=compareKeywordWithStepContent(t.messages,e),e=compareKeywordWithStepContent(t.clarification,e);return a.length&&s.push(a),e.length&&s.push(e),!!s.length&&{matches:s,...t}}function compareKeywordWithStepContent(e,l){const a=[];return e?.forEach(e=>{const o={message:e,matchedParts:[]};var t,s;e.text?.toLowerCase()?.includes(l)&&(s=(t=e.text.toLowerCase().indexOf(l))+l.length,t=Math.max(t-10,0),s=Math.min(s+10,e.text.length),t=e.text.substring(t,s),o.matchedParts.push({part:"text",matchedText:t})),e.header?.text?.toLowerCase()?.includes(l)&&(t=(s=e.header.text.toLowerCase().indexOf(l))+l.length,s=Math.max(s-10,0),t=Math.min(t+10,e.header.text.length),s=e.header.text.substring(s,t),o.matchedParts.push({part:"header",matchedText:s})),e.buttons?.some(e=>e?.toLowerCase()?.includes(l))&&e.buttons.forEach((e,t)=>{var s,a;e?.toLowerCase()?.includes(l)&&(a=(s=e.toLowerCase().indexOf(l))+l.length,s=Math.max(s-10,0),a=Math.min(a+10,e.length),e=e.substring(s,a),o.matchedParts.push({part:`buttons[${t+1}]`,matchedText:e}))}),e.options?.some(e=>e?.toLowerCase()?.includes(l))&&e.options.forEach((e,t)=>{var s,a;e?.toLowerCase()?.includes(l)&&(a=(s=e.toLowerCase().indexOf(l))+l.length,s=Math.max(s-10,0),a=Math.min(a+10,e.length),e=e.substring(s,a),o.matchedParts.push({part:`options[${t+1}]`,matchedText:e}))}),o.matchedParts.length&&a.push(o)}),a}function displaySearchResults(e){searchResults.innerHTML="",e?.length?(searchResults.style.display="block",e.forEach(s=>{s.matches.forEach(e=>{e.forEach(e=>{e.matchedParts.forEach(e=>{var t=document.createElement("li");t.textContent=`${e.matchedText} - match [${e.part}] - in [${s.name}]`,t.dataset.stepname=s.name,t.addEventListener("click",handleResultClick),searchResults.appendChild(t)})})})})):searchResults.style.display="none"}function handleResultClick(e){const t=e.target.dataset.stepname;openDetailsModel(globalThis.selectedFlow.steps.find(e=>e.name==t))}function deepSearch(a){let o=[];return globalThis.selectedFlow.steps.find(t=>{for(const s in t)!["messages","clarification"].includes(s)&&"string"==typeof t[s]&&t[s]?.toLowerCase()?.includes(a)&&o.push({value:t[s],field:s,step:t}),"expected"==s&&t[s]?.forEach(e=>{e?.entity?.toLowerCase()?.includes(a)&&o.push({value:e?.entity,field:s,step:t}),e?.step?.toLowerCase()?.includes(a)&&o.push({value:e?.step,field:s,step:t})}),"aiLabels"==s&&t[s]?.forEach(e=>{e?.toLowerCase()?.includes(a)&&o.push({value:e,field:s,step:t})}),"expiry"==s&&t[s]?.step?.toLowerCase()?.includes(a)&&o.push({value:t[s]?.step,field:s,step:t})}),o}function displayDeepSearchResults(e){searchResults.innerHTML="",e?.length?(searchResults.style.display="block",e.forEach(e=>{var t=document.createElement("li");t.textContent=`${e.value} - type [${e.field}] - in [${e.step?.name}]`,t.dataset.stepname=e.step?.name,t.addEventListener("click",handleResultClick),searchResults.appendChild(t)})):searchResults.style.display="none"}function openDetailsModel(e){e=createHtmlView(e);swal({content:{element:"div",attributes:{innerHTML:e}},className:"custom-swal-content",width:"fit-content"})}function createHtmlView(e){let a="";return a+='<h2 style="text-align: center; font-weight: bold;">'+e.name+"</h2>",function s(e){Array.isArray(e)?(a+="<ul>",e.forEach(e=>{a+="<li>",s(e),a+="</li>"}),a+="</ul>"):"object"==typeof e&&null!==e?(a+="<ul>",Object.entries(e).forEach(([e,t])=>{null!=t&&(a+='<li><span class="key">'+e+":</span> ",s(t),a+="</li>")}),a+="</ul>"):a+='<span class="value">'+e+"</span>"}(e),a}document.getElementById("textSearchInput").addEventListener("keyup",debounce(handleInputChangeInTextSearch,1e3));