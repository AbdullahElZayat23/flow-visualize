let popup=document.getElementById("popup");function showPopup(){popup.classList.add("active"),toggleButtons()}function closePopup(){popup?.classList.remove("active")}function optionSelected(e){if(globalThis.selectedFlow?.name&&globalThis.selectedFlow?.steps?.length)switch(e){case"1":showReport(globalThis.stepsWithErrors.map(e=>({Name:e.text.name.replace("name => ",""),Errors:e.text.errors.replace("Errors => ",""),index:e.index})),["Name","Errors","Index"],globalThis.selectedFlow.name,"steps-with-erros");break;case"2":showReport(globalThis.stepsWithoutCaller.map(e=>({Name:e.name,Template:e.template,index:e.index})),["Name","Is template","Index"],globalThis.selectedFlow.name,"steps-without-caller");break;case"3":showReport(globalThis.duplicatedSteps.map(e=>({Name:e.name})),["Name"],globalThis.selectedFlow.name,"duplicated-steps");break;case"4":showReport(globalThis.allStepsWithErrors.map(t=>({Name:t.text.name.replace("name => ",""),Errors:t.text.errors.replace("Errors => ",""),index:t.index,hasCaller:!globalThis.stepsWithoutCaller.find(e=>e.name==t.text.name.replace("name => ",""))})),["Name","Errors","Index","Has caller"],globalThis.selectedFlow.name,"all-steps-with-errors");break;case"5":showModal(),removeOptions(),addOptions(globalThis.uniqueSteps),removeOptionsGlobal(),addOptionsGlobal(globalThis.uniqueSteps)}else showFeedBack({title:"No Steps To Filter",text:"There are no steps to filter at the moment. Please render a flow first",icon:"info"});closePopup()}function extractSteps(){let e=[],t=document.getElementById("steps_type").value;if(t){switch(t){case"template":e=globalThis.selectedFlow.steps.filter(e=>e.template);break;case"none":e=globalThis.selectedFlow.steps.filter(e=>!e.type);break;default:e=globalThis.selectedFlow.steps.filter(e=>e.type==t)}closeModal(),e.length?exportFlow({steps:e,name:globalThis.selectedFlow.name}):showFeedBack({title:"No Steps Found With The Chosen Criteria",text:"There are no steps with the chosen criteria",icon:"info"})}}function showModal(){document.getElementById("moreModal").classList.add("active")}function closeModal(){document.getElementById("moreModal")?.classList.remove("active")}function showReport(e,t,s,o){e?.length&&createTable(e,t,s,o)}function createTable(e,t,s,o){var a=XLSX.utils.book_new(),e=XLSX.utils.json_to_sheet(e);XLSX.utils.sheet_add_aoa(e,[t],{origin:"A1"}),XLSX.utils.book_append_sheet(a,e,o||"Sheet"),XLSX.writeFile(a,`${s}-${o}-${(new Date).toISOString()}.xlsx`)}function searchStep(){closeModal();var e=parseInt(document.getElementById("step-number").value);let t;try{if(!(t=globalThis.selectedFlow?.steps[e]))return void showFeedBack({title:"Step not Found",text:"There is no step in the tree with the index you entered, or the step has no name. Please check your inputs.",icon:"info"})}catch(e){return void showFeedBack({title:"Step not Found",text:"There is no step in the tree with the index you entered, or the step has no name. Please check your inputs.",icon:"info"})}let s=null;var o=document.querySelectorAll(".nodeExample1 p.node-name");for(let e=0;e<o.length;e++)if(o[e].textContent.trim()==="name => "+t?.name&&![...o[e].parentNode.classList].includes("circular_refrence")){s=o[e].parentNode;break}s?(s.scrollIntoView({behavior:"smooth",block:"center"}),s.style.backgroundColor="#ffffcc",setTimeout(function(){s.style.backgroundColor=""},4e3)):showFeedBack({title:"Step not Found",text:"There is no step in the tree with the index you entered, or the step has no name. Please check your inputs.",icon:"info"})}function addOptions(e){var t=document.getElementById("steps_dropdown"),e=e?.map(e=>{var t=document.createElement("option");return t.text=e.name,t.value=e.name,t});e?.length&&(t.append(...e),updateDropdown())}function removeOptions(){document.getElementById("steps_dropdown").innerHTML="",updateDropdown()}function updateDropdown(){var e=document.getElementById("steps_dropdown");e.fstdropdown&&e.fstdropdown.rebind()}function extractFlow(){const t=document.getElementById("steps_dropdown")?.value;var e,s=globalThis.selectedFlow?.steps.find(e=>e.name==t);closeModal(),s?(loader.style.display="block",globalThis.flowToExtractVisitedSteps=new Set,(e=getChildrenForExtraction(s,globalThis.selectedFlow.steps)).unshift(s),s={...globalThis.selectedFlow,steps:e},exportFlow(s)):showFeedBack({title:"No Step Found With The Entered Name",text:"Make Sure Step Name Is Correct.",icon:"info"})}function mergeSteps(){if(closeModal(),globalThis.uploadedFileJSOnsData?.steps?.length){var e=globalThis.selectedFlow.steps,t=globalThis.uploadedFileJSOnsData.steps;const s=new Map;e.forEach(e=>{s.set(e.name,e)}),t.forEach(e=>{s.set(e.name,e)}),exportFlow({...globalThis.selectedFlow,steps:Array.from(s.values())},{name:globalThis.selectedFlow.name+"-merged"})}else showFeedBack({title:"Select Data Source",text:"Select Data Source To Merge From",icon:"info"})}function addStep(){closeModal();var e=document.getElementById("step-text-area").value;let t,o=[],s=[];try{t=JSON.parse(e)}catch(e){return void showFeedBack({title:"Error",text:"Failed to parse JSON data. Please make sure the inserted step/s contains valid / pure JSON data.",icon:"error"})}(t=Array.isArray(t)?t:[t]).forEach((e,t)=>{var s=findErrors(e);s.length&&o.push({name:e.name,errors:s})}),t.forEach(t=>{globalThis.selectedFlow.steps.find(e=>e.name==t.name)&&s.push(t)}),s.length?(showReport(s.map(e=>({Name:e.name})),["Name"],"new steps","inserted-steps-with-duplication"),showFeedBack({title:"Error",text:"Inserted Steps Contain Duplications. See the exported sheet for details.",icon:"error"})):o.length?(showReport(o.map(e=>({Name:e.name,Errors:e.errors.join(", ")})),["Name","Errors"],"new steps","inserted-steps-with-errors"),showFeedBack({title:"Error",text:"Inserted Steps Contain Errors. See the exported sheet for details.",icon:"error"})):(e=globalThis.selectedFlow.steps.concat(t),e={...globalThis.selectedFlow,steps:e},updateFlowVisualization(e))}function traceChildrenPaths(){closeModal(),exportFlow({paths:globalThis.paths},{name:globalThis.selectedFlow.name+"-paths"}),showReport(Object.keys(globalThis.paths).map(e=>({key:e,value:globalThis.paths[e]})).map(e=>({Name:e.key,Paths:e.value?.paths?.join(" , ")})),["Name","Paths"],globalThis.selectedFlow.name,"childrens-trace")}function debounce(s,o){let a;return function(){const e=this,t=arguments;clearTimeout(a),a=setTimeout(function(){s.apply(e,t)},o)}}function handleInputChangeInTextSearch(){let t=document.getElementById("textSearchInput").value,s=[],e=[];var o;t.trim()?.length&&globalThis.selectedFlow?.steps?.length&&(advancedsearch.checked?displayDeepSearchResults(e=deepSearch(t.toLowerCase())):(globalThis.selectedFlow?.steps?.forEach(e=>{e=serachForTextInsideStep(t.toLowerCase(),e);e&&s.push(e)}),displaySearchResults(s)),e.length||s.length)&&((o=document.createElement("i")).className="fa-sharp fa-solid fa-circle-xmark",o.style.cursor="pointer",o.style.float="right",o.style.margin="3px",searchResults.insertBefore(o,searchResults.firstChild),o.addEventListener("click",function(){searchResults.style.display="none"}))}function serachForTextInsideStep(e,t){var s=[],o=compareKeywordWithStepContent(t.messages,e,"MSGS"),e=compareKeywordWithStepContent(t.clarification,e,"CLRFC");return o.length&&s.push(o),e.length&&s.push(e),!!s.length&&{matches:s,...t}}function compareKeywordWithStepContent(e,o,a){const t=[];return e?.forEach(e=>{const s={message:e,matchedParts:[]};e.text&&findMatchesInString(e.text,"text-"+a,s,o),e.header?.text&&findMatchesInString(e.header.text,"header-"+a,s,o),e.buttons?.forEach((e,t)=>{e&&findMatchesInString(e,`buttons[${t+1}]-`+a,s,o)}),e.options?.forEach((e,t)=>{e&&findMatchesInString(e,`options[${t+1}]-`+a,s,o)}),s.matchedParts.length&&t.push(s)}),t}function findMatchesInString(e,t,s,o){var a=e.removeEscapeCharacters().toLowerCase();a.includes(o)&&(o=(a=a.indexOf(o))+o.length,a=Math.max(a-10,0),o=Math.min(o+10,e.length),e=e.substring(a,o),s.matchedParts.push({part:t,matchedText:e}))}function displaySearchResults(e){searchResults.innerHTML="",e?.length?(searchResults.style.display="block",e.forEach(s=>{s.matches.forEach(e=>{e.forEach(e=>{e.matchedParts.forEach(e=>{var t=document.createElement("li");t.textContent=`${e.matchedText} - match [${e.part}] - in [${s.name}]`,t.dataset.stepname=s.name,t.addEventListener("click",handleResultClick),searchResults.appendChild(t)})})})})):searchResults.style.display="none"}function handleResultClick(e){const t=e.target.dataset.stepname;openDetailsModel(globalThis.selectedFlow.steps.find(e=>e.name==t))}function deepSearch(o){let a=[];return globalThis.selectedFlow.steps.find(t=>{for(const s in t)!["messages","clarification"].includes(s)&&"string"==typeof t[s]&&t[s]?.toLowerCase()?.includes(o)&&a.push({value:t[s],field:s,step:t}),"expected"==s&&t[s]?.forEach(e=>{e?.entity?.toLowerCase()?.includes(o)&&a.push({value:e?.entity,field:s,step:t}),e?.step?.toLowerCase()?.includes(o)&&a.push({value:e?.step,field:s,step:t})}),"aiLabels"==s&&t[s]?.forEach(e=>{e?.toLowerCase()?.includes(o)&&a.push({value:e,field:s,step:t})}),"expiry"==s&&t[s]?.step?.toLowerCase()?.includes(o)&&a.push({value:t[s]?.step,field:s,step:t}),"labels"==s&&t[s]?.forEach(e=>{e?.toLowerCase()?.includes(o)&&a.push({value:e,field:s,step:t})})}),a}function displayDeepSearchResults(e){searchResults.innerHTML="",e?.length?(searchResults.style.display="block",e.forEach(e=>{var t=document.createElement("li");t.textContent=`${e.value} - type [${e.field}] - in [${e.step?.name}]`,t.dataset.stepname=e.step?.name,t.addEventListener("click",handleResultClick),searchResults.appendChild(t)})):searchResults.style.display="none"}function openDetailsModel(e){e=createHtmlView(e);showFeedBack({html:"<div>"+e+"</div>",customClass:"custom-swal-content"})}function createHtmlView(e){let o="";return o+='<h2 style="text-align: center; font-weight: bold;">'+e.name+"</h2>",function s(e){Array.isArray(e)?(o+="<ul>",e.forEach(e=>{o+="<li>",s(e),o+="</li>"}),o+="</ul>"):"object"==typeof e&&null!==e?(o+="<ul>",Object.entries(e).forEach(([e,t])=>{null!=t&&(o+='<li><span class="key">'+e+":</span> ",s(t),o+="</li>")}),o+="</ul>"):o+='<span class="value">'+e+"</span>"}(e),o}function stepsContainsEffect(){closeModal();var e=globalThis.selectedFlow.steps.filter(e=>e.effect);globalThis.selectedFlow?.failStep?.effect&&e.push({...globalThis.selectedFlow.failStep,name:"##The Fail step"}),showReport(e.map(e=>({Name:e.name||"unknown step name",Effect:e.effect})),["Name","Effect"],globalThis.selectedFlow.name,"steps-with-effect")}function addOptionsGlobal(e){var t=document.querySelectorAll(".steps_dropdown_global");const s=e?.map(e=>{var t=document.createElement("option");return t.text=e.name,t.value=e.name,t});s?.length&&t.forEach(t=>{s.forEach(e=>{t.appendChild(e.cloneNode(!0))}),t.fstdropdown?.rebind()})}function removeOptionsGlobal(){document.querySelectorAll(".steps_dropdown_global").forEach(e=>{e.innerHTML="",e.fstdropdown?.rebind()})}function ExtractPathBetweenTwoPoints(){let t=document.getElementById("path_start_step").value,s=document.getElementById("path_end_step").value;t&&s&&(closeModal(),loader.style.display="block",setTimeout(()=>{var e=findAllPathsBetweenTwoPoints(t,s,globalThis.uniqueSteps);loader.style.display="none",e.length?showReport(e.map(e=>({Paths:e})),["Paths"],"paths","chosen-flow-paths"):showFeedBack({title:"No paths between both steps to extract",text:"There are no paths between the selected steps, either there is no path or the order of steps chosen is wrong",icon:"info"})},1e3))}function findAllPathsBetweenTwoPoints(e,t,s){var o=[];return findSimplePaths(s,e,t,new Set,[],o),o}function findSimplePaths(t,s,o,a,n,l){if(n.push({node:s,linkType:null}),a.add(s),s===o){var e=n.map(e=>e.linkType?e.node+" => "+e.linkType:e.node);l.push(e.join(" => ")),console.log(e.join(" => "))}else{var r=t.find(e=>e.name===s);for(const c of["next","success","fail","expiry.step"]){let e;(e="expiry.step"==c?r.expiry?.step:r[c])&&!a.has(e)&&(n[n.length-1].linkType=c,findSimplePaths(t,e,o,a,n,l),n[n.length-1].linkType=null)}for(const p of r.expected||[]){var i=p.step;i&&!a.has(i)&&(n[n.length-1].linkType="expected.step",findSimplePaths(t,i,o,a,n,l),n[n.length-1].linkType=null)}}n.pop(),a.delete(s)}String.prototype.removeEscapeCharacters=function(){return this.replace(/[\n\r\t]/g," ")},document.getElementById("textSearchInput").addEventListener("keyup",debounce(handleInputChangeInTextSearch,1e3));